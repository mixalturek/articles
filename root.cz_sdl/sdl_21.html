<?xml version="1.0" encoding="iso-8859-2"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="cs" lang="CS">

<head>
<meta http-equiv="content-type" content="text/html; charset=iso-8859-2" />
<meta http-equiv="content-language" content="cs" />
<meta name="author" content="all: Michal Turek - Woq; WOQ (zavináè) seznam.cz" />
<style type="text/css" media="all">@import "./data/style.css";</style>
<title>SDL: Hry nejen pro Linux (21)</title>
</head>

<body>

<h1>SDL: Hry nejen pro Linux (21)</h1>

<p class="perex">Dal¹í oblastí knihovny SDL, kterou si popí¹eme, bude API pro práci s CD-ROM. Po pøeètení tohoto èlánku byste mìli být schopni si vytvoøit jednoduchý CD pøehrávaè, jen¾ zahrnuje pøehrávání a pauzy, listování a pohyb ve skladbách a také vysouvání mechaniky pro vlo¾ení nového disku.</p>


<h2>Inicializace CD-ROM</h2>

<p>Aby bylo mo¾né pøehrávat hudbu z CD, je nejprve nutné ve funkci SDL_Init() zapnout symbolickou konstantou SDL_INIT_CDROM podporu CD mechanik. Tím je defakto základní inicializace hotová a mù¾e se pøistoupit k vlastnímu programování.</p>

<p>Dále se musí polo¾it dotaz, je-li v poèítaèi vùbec nìjaká CD mechanika, bez ní to opravdu nepùjde :-]. Funkce SDL_CDNumDrives() poskytuje jejich celkový poèet a pokud je nutné zjistit také systémová jména, lze pou¾ít SDL_CDName(). Za parametr se jí pøedávají èísla z rozsahu od nuly do poètu v¹ech mechanik a vrací ukazatel na øetìzec jako je /dev/cdrom, D:\ apod. Jedná se pouze o informativní hodnotu.</p>

<pre>
int SDL_CDNumDrives(void);
const char *SDL_CDName(int drive);
</pre>

<p>Mechanika s daným poøadovým èíslem, nultá je defaultní v systému, se otevøe funkcí SDL_CDOpen(). Návratová hodnota pøedstavuje ukazatel na objekt struktury SDL_CD, které se budeme podrobnì vìnovat ní¾e. Identifikátor se po skonèení práce uvolòuje funkcí SDL_CDClose().</p>

<pre>
SDL_CD *SDL_CDOpen(int drive);
void SDL_CDClose(SDL_CD *cdrom);
</pre>

<p>Poslední otevøená mechanika se stane v aplikaci defaultní. To znamená, ¾e se na ni lze pøi volání funkcí odkazovat argumentem NULL, který je pøedán místo identifikátoru SDL_CD.</p>


<h2>Informace o CD</h2>

<p>Po vlo¾ení CD do mechaniky je nutné funkcí SDL_CDStatus() aktualizovat obsah CD_ROM struktury.</p>

<pre>
CDstatus SDL_CDStatus(SDL_CD *cdrom);
</pre>

<p>Návratová hodnota poslou¾í pro získání stavových informací. Je jí výètový typ, který mù¾e nabývat hodnot CD_TRAYEMPTY, CD_STOPPED, CD_PLAYING, CD_PAUSED a CD_ERROR. SDL také poskytuje makro CD_INDRIVE() podávající informaci, zda je v mechanice nìjaký disk.</p>

<pre>
#define CD_INDRIVE(status) ((int)status > 0)

// Pou¾ití
if(CD_INDRIVE(SDL_CDStatus(cdrom)))
	ZacniPrehravat();
</pre>

<p>Struktura SDL_CD jednoznaènì identifikuje otevøenou CD mechaniku a také podává informace o disku, který je do ní vlo¾ený. První dvì polo¾ky jsou dostupné obecnì, ostatní jsou validní pouze s CD. Aktuálnost obsahu je dána posledním voláním funkce SDL_CDStatus().</p>

<pre>
typedef struct
{
	int id;			// Privátní identifikátor
	CDstatus status;	// Stavové informace

	int numtracks;
	int cur_track;
	int cur_frame;
	SDL_CDtrack track[SDL_MAX_TRACKS+1];
} SDL_CD;
</pre>

<p>CD je obecnì organizováno do jedné nebo více stop (v angliètinì track), v naprosté vìt¹inì pøípadù je v ka¾dé z nich ulo¾ena jedna skladba. Stopy se dále skládají z urèitého poètu framù, co¾ jsou bloky dat o velikosti cca. 2 kB, které pøedstavují základní stavební jednotky CD. Pøi normální rychlosti se za jednu sekundu pøehraje 75 framù. Tato hodnota je v SDL definována jako symbolická konstanta CD_FPS.</p>

<p>Numtracks uchovává poèet stop na disku, cur_track obsahuje èíslo aktuálnì pøehrávané stopy a cur_frame èíslo pøehrávaného framu ve stopì. Samozøejmì nesmí chybìt ani pole stop. Jeho velikost je definována staticky konstantou SDL_MAX_TRACKS rovnající se 99.</p>

<p>Struktura SDL_CDtrack popisuje jednotlivé stopy na CD, pro pochopení by mìly staèit komentáøe.<p>

<pre>
typedef struct
{
	Uint8 id;	// ID stopy
	Uint8 type;	// SDL_AUDIO_TRACK nebo SDL_DATA_TRACK
	Uint16 unused;
	Uint32 length;	// Délka stopy ve framech
	Uint32 offset;	// Offset ve framech od zaèátku disku
} SDL_CDtrack;
</pre>

<p>SDL internì pracuje s framy, nicménì èasové údaje lze velice jednodu¹e získat makrem FRAMES_TO_MSF(). Prvním argumentem je poèet framù, který se má pøevést na èas, a do M, S, F budou ulo¾eny minuty, sekundy a zbylý poèet framù. Opaèný smìr je také mo¾ný - MSF_TO_FRAMES().</p>

<pre>
#define FRAMES_TO_MSF(f, M,S,F) \
{				\
	int value = f;		\
	*(F) = value % CD_FPS;	\
	value /= CD_FPS;	\
	*(S) = value % 60;	\
	value /= 60;		\
	*(M) = value;		\
}

#define MSF_TO_FRAMES(M, S, F)	\
		((M)*60*CD_FPS+(S)*CD_FPS+(F))
</pre>

<p>Pokud by byla potøeba pouze délka v sekundách, staèí jen obyèejné dìlení frames / CD_FPS. V následujícím pøíkladì se vypí¹í informace o délce v¹ech stop na CD.</p>

<pre>
int min, sec, fr;

SDL_CDStatus(g_cdrom);// Aktualizace informací
printf("Poèet stop: %d\n", g_cdrom-&gt;numtracks);

for(int i = 0; i &lt; g_cdrom->numtracks; i++)
{
	FRAMES_TO_MSF(g_cdrom-&gt;track[i].length, &min, &sec, &fr);
	printf("Stopa %d: %5d = %d:%2d, %2d\n", i,
			g_cdrom-&gt;track[i].length, min, sec, fr);
}
</pre>

<p>Výstup bude u audio CD vypadat nìjak takto.</p>

<pre>
Poèet stop: 9
Stopa 0: 10087 = 2:14, 37
Stopa 1: 10568 = 2:20, 68
Stopa 2: 18475 = 4:06, 25
Stopa 3: 16778 = 3:43, 53
Stopa 4: 11059 = 2:27, 34
Stopa 5:  5423 = 1:12, 23
Stopa 6: 15167 = 3:22, 17
Stopa 7:  5851 = 1:18,  1
Stopa 8: 11906 = 2:38, 56
</pre>


<h2>Pøehrávání</h2>

<p>Základní funkcí pro pøehrávání je SDL_CDPlay(). Pøedává se jí poèáteèní frame a poèet, který se má celkovì pøehrát. Pokud bude úspì¹ná vrátí nulu, jinak -1.</p>

<pre>
int SDL_CDPlay(SDL_CD *cdrom, int start, int length);
</pre>

<p>Mnohem èastìji ne¾ SDL_CDPlay() se ale pou¾ívá SDL_CDPlayTracks(), proto¾e poskytuje snadnou volbu toho, co se má pøehrávat.</p>

<pre>
int SDL_CDPlayTracks(SDL_CD *cdrom, int start_track,
		int start_frame, int ntracks, int nframes);
</pre>

<p>Start_track a ntracks oznaèují první pøehrávanou stopu a jejich celkový poèet. Start_frame je offsetem ve framech od poèáteèní stopy a nframes offsetem od poslední. Pokud budou poslední dva parametry nulové, pøehrává se a¾ do konce CD. Datové oblasti jsou automaticky pøeskakovány. Následující tøi pøíklady byly pøebrány ze SDL dokumentace.</p>

<pre>
// Pøehraje se celé CD
if(CD_INDRIVE(SDL_CDStatus(cdrom)))
	SDL_CDPlayTracks(cdrom, 0, 0, 0, 0);

// Pøehraje se poslední stopa
if(CD_INDRIVE(SDL_CDStatus(cdrom)))
	SDL_CDPlayTracks(cdrom, cdrom->numtracks-1, 0, 0, 0);

// Pøehraje 15 sekund ze druhé stopy
if(CD_INDRIVE(SDL_CDStatus(cdrom)))
	SDL_CDPlayTracks(cdrom, 1, 0, 0, CD_FPS*15);
</pre>

<p>Následují nezbytné funkce ka¾dého pøehrávání. Mimochodem, pokud se nezavolá SDL_CDStop(), CD se pøehrává i po ukonèení aplikace!</p>

<pre>
int SDL_CDPause(SDL_CD *cdrom);	// Pozastavení
int SDL_CDResume(SDL_CD *cdrom);// Obnovení
int SDL_CDStop(SDL_CD *cdrom);	// Zastavení
</pre>

<p>Pomocí SDL_CDEject() lze disk vysunout z mechaniky.</p>

<pre>
int SDL_CDEject(SDL_CD *cdrom);
</pre>


<h2></h2>

<p></p>


<h2></h2>

<p></p>


<h2>Ukázkové programy</h2>

<h3>CD pøehrávaè</h3>

<p>Program implementuje velice jednoduchý CD pøehrávaè, který umo¾òuje pøechody mezi stopami, posuny pøi pøehrávání, pozastavení a také vysunutí mechaniky. Po spu¹tìní programu s volbou -h nebo --help se zobrazí ovládání. V¹echny informace se vypisují do konzole.</p>


<h2>Download</h2>

<p><ul>
<li><a href="./src/sdl_21_a.tar.gz">Pøíklad: Jednoduchý CD pøehrávaè</a></li>
<li><a href="sdl_21.tar.gz">Offline verze èlánku vèetnì v¹ech pøíloh</a></li>
</ul></p>


<h2>Pokraèování</h2>

<p>Zdárnì dokonèili jsme dokonèili zvuky a hudbu, pøí¹tì se budeme vìnovat vícevláknovému programování.</p>


<div class="autor">Michal Turek - Woq &lt;WOQ (zavináè) seznam.cz&gt;, 04.07.2005</div>

</body>
</html>
