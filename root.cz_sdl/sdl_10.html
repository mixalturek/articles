<?xml version="1.0" encoding="iso-8859-2"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="cs" lang="CS">

<head>
<meta http-equiv="content-type" content="text/html; charset=iso-8859-2" />
<meta http-equiv="content-language" content="cs" />
<meta name="author" content="all: Michal Turek - Woq; WOQ (zavináè) seznam.cz" />
<style type="text/css" media="all">@import "./data/style.css";</style>
<title>SDL: Hry nejen pro Linux (10)</title>
</head>

<body>

<h1>SDL: Hry nejen pro Linux (10)</h1>

<p class="perex">Seriál se pøehoupl do druhé desítky, pøí¹tì u¾ na poèítání pøestanou staèit prsty ;-). Ale je¹tì ne¾ se tak stane, probereme si komunikaci aplikace se správcem oken, co¾ v sobì zahrnuje zmìnu titulku okna, minimalizaci, pøepínání do/z fullscreenu a nìkolik dal¹ích vìcí. Ke konci bude také pøidán lehký úvod do zpracování událostí.</p>


<h2>Správce oken</h2>

<p>Knihovna SDL poskytuje nìkolik pøíkazù, které zaji¹»ují komunikaci mezi aplikací a správcem oken (Window Manager). Samozøejmì není mo¾né komunikovat, neexistuje-li druhá strana - vìt¹inou se jedná o bìh v textovém re¾imu, kdy¾ není spu¹tìný X server. SDL toho po pravdì nepodporuje mnoho, v podstatì pouze zmìnu názvu a ikony v titulkovém pruhu, programovou minimalizaci okna a pøepnutí do/z fullscreenu. Názvy funkce, které zaji¹»ují tyto èinnosti, zaèínají na pøedponu SDL_WM_.</p>


<h2>Titulkový pruh</h2>

<p>Zaèneme jednodu¹e, øetìzec v titulku okna se zmìní funkcí SDL_WM_SetCaption(), ostatnì tato funkce byla pou¾ita snad ve v¹ech ukázkových pøíkladech, tak¾e by se nemìlo jednat o nic nového.</p>

<pre>
void SDL_WM_SetCaption(const char *title, const char *icon);
void SDL_WM_GetCaption(char **title, char **icon);
</pre>

<p>První parametr je jasný, specifikuje se jím øetìzec v titulku. Existenci druhého jsem v¹ak nikdy nepochopil. SDL dokumentace ho popisuje jako &quot;jméno ikony&quot; a ani hlavièkový soubor ani zdrojové kódy více informací bohu¾el neposkytují. Co si pod ním pøedstavit tedy opravdu netu¹ím. Mo¾ná se jedná o &quot;textovou ikonu&quot;, pro správce oken, které grafické neumo¾òují, ale toto je pouze má neovìøená spekulace. Ka¾dopádnì, pokud se pøedá NULL, nic se nezkazí.</p>

<p>Ikona aplikace se nastavuje funkcí SDL_WM_SetIcon(), která by mìla být volána pøed SDL_SetVideoMode(). Co se týká rozmìrù, jsou doporuèovány klasické 32x32 pixelù velké ikony, nemìly by s nimi být ¾ádné problémy.</p>

<pre>
void SDL_WM_SetIcon(SDL_Surface *icon, Uint8 *mask);
</pre>

<p>První parametr pøedstavuje surface s ikonou a druhý je bitovou maskou pro prùhledné èásti. Je-li pøedáno NULL, pou¾ije se klíèová barva surface a pokud ani ta není specifikována, bude ikona neprùhledná.</p>

<p>Bity masky nastavené do jednièky specifikují zobrazované a nuly naopak prùhledné pixely, øádky jdou od shora dolù a ka¾dý z nich se skládá z (¹íøka / 8) bytù, zaokrouhleno nahoru. Nejvýznamnìj¹í bit ka¾dého bytu reprezentuje nejlevìj¹í pixel.</p>

<p>Typický pøíklad nastavení ikony okna, která nepou¾ívá prùhlednost mù¾e vypadat napøíklad takto:</p>

<pre>
// Pøed SDL_SetVideoMode()
SDL_Surface *icon = SDL_LoadBMP("./icon.bmp");
if(icon != NULL)
{
	SDL_WM_SetIcon(icon, NULL);
	SDL_FreeSurface(icon);
}
</pre>


<h2>Minimalizace okna</h2>

<p>Okno se dá programem minimalizovat voláním funkce SDL_WM_IconifyWindow(). Vrácená nula znaèí, ¾e minimalizace buï není podporována, nebo ji správce oken odmítl provést. V pøípadì, ¾e se v¹e uskuteènilo v poøádku, obdr¾í aplikace zprávu SDL_APPACTIVE s parametrem oznaèujícím ztrátu fokusu.</p>

<pre>
int SDL_WM_IconifyWindow(void);
</pre>


<h2>Pøepnutí do/z fullscreenu</h2>

<p>Pro pøepnutí mezi oknem a fullscreenem staèí jediný øádek kódu. Tedy, abychom byli pøesní, staèil by, pokud by nebyla funkce SDL_WM_ToggleFullScreen() podporována pouze v X11, v BeOSu je zatím pouze experimentálnì.</p>

<pre>
int SDL_WM_ToggleFullScreen(SDL_Surface *surface);
</pre>

<p>Funkce vrací pøi úspìchu jednièku, jinak nulu, po jejím zavolání by se obsah okna nemìl zmìnit. Pokud surface okna nevy¾aduje zamykání pøi pøístupu k pixelùm, bude ukazatel obsahovat stejnou adresu pamìti jako pøed voláním.</p>

<p>Jak u¾ bylo zmínìno, pokud program nebì¾í pod X11, ale napøíklad v MS Windows, pøepnutí mezi oknem a celoobrazovkovým re¾imem nelze provést. Nicménì..., jak ukazuje demonstraèní pøíklad ní¾e, není problém okno zru¹it a následnì ho znovu vytvoøit s negovaným parametrem re¾imu.</p>

<pre>
#define WIN_WIDTH 640
#define WIN_HEIGHT 480
#define WIN_BPP 0

// Globální promìnné
SDL_Surface *g_screen;
Uint32 g_win_flags = SDL_RESIZABLE|SDL_FULLSCREEN;

// Pøepíná mezi re¾imy okno/fullscreen
bool ToggleFullscreen()
{
	if(g_win_flags &amp; SDL_FULLSCREEN)// Z fullscreenu do okna
		g_win_flags &amp;= ~SDL_FULLSCREEN;
	else// Z okna do fullscreenu
		g_win_flags |= SDL_FULLSCREEN;

	// Pokus o pøepnutí, podporováno pouze v x11
	if(SDL_WM_ToggleFullScreen(g_screen) == 0)
	{
		fprintf(stderr, "Unable to toggle fullscreen,"
				"trying to recreate window\n");

		SDL_FreeSurface(g_screen);
		g_screen = SDL_SetVideoMode(WIN_WIDTH, WIN_HEIGHT,
				WIN_BPP, g_win_flags);

		if(g_screen == NULL)
		{
			fprintf(stderr, "Unable to recreate window: %s\n",
					SDL_GetError());
			return false;// Ukonèí program
		}

#ifdef OPENGL_APLIKACE
		// Reinicializace OpenGL (parametry, textury...),
		// starý kontext u¾ není dostupný
		if(!InitGL())
		{
			fprintf(stderr, "Unable to reinitialize OpenGL\n");
			return false;// Ukonèí program
		}

		ResizeGLWindow();// Nastaví perspektivu
#endif

		Draw();// Pøekreslí scénu
	}

	return true;// OK
}
</pre>

<p>Tato a jí podobné funkce se vìt¹inou volají v reakci na stisk nìjaké klávesy, a proto¾e se v tomto èlánku zaèínáme zabývat událostmi, pøíklad volání lze nalézt ní¾e...</p>


<h2>Zpùsob grabování vstupù</h2>

<p>Následující funkce umo¾òuje nastavit zpùsob grabování vstupù klávesnice a my¹i.</p>

<pre>
SDL_GrabMode SDL_WM_GrabInput(SDL_GrabMode mode);
</pre>

<p>V pøípadì, ¾e je nastaveno SDL_GRAB_OFF (implicitní nastavení) budou se zprávy pøedávat oknu pouze tehdy, pokud je aktivní (má fokus). Naopak, je-li ve stavu SDL_GRAB_ON, my¹ nemù¾e opustit klientskou oblast okna a v¹echny vstupy klávesnice jsou pøedávány pøímo oknu, èili nejsou interpretovány okenním mana¾erem. Poslední mo¾ný parametr SDL_GRAB_QUERY slou¾í k dotazu na aktuální stav.</p>


<h2>Správa událostí</h2>

<p>Komunikace mezi operaèním systémem a SDL aplikací je vystavìna na tzv. událostním modelu. V¾dy, kdy¾ v systému nastane nìjaká událost, napøíklad u¾ivatel stiskne klávesu nebo pohne my¹í, generuje operaèní systém objekt dané události, nastaví jeho parametry (stisknutá klávesa, nová pozice my¹i) a pøedá ho aplikaci. Nìkdy se také øíká, ¾e operaèní systém poslal aplikaci zprávu o události. Ta na ni mù¾e zareagovat naprosto libovolným zpùsobem, vèetnì její ignorace.</p>

<p>Povídání o událostech zaèneme praktickým pøíkladem jejich zpracování. V tuto chvíli nemusíte pochopit naprosto v¹echny detaily, pokud v¹ak vstøebáte základní principy, máte z 95 procent vyhráno, dále u¾ se bude jednat jen o nabalování speciálních znalostí. No, a pokud následující pøíklad nepochopíte, tak to zkuste je¹tì jednou ;), od této chvíle se bez tìchto vìcí neobejdete.</p>

<p>Bývá dobrým zvykem vlo¾it ve¹kerou práci s událostmi do specializované funkce. Definujeme, ¾e vrácené false z ProcessEvent() øíká hlavní smyèce programu, ¾e je z nìjakého dùvodu nutné ukonèit aplikaci. V tomto pøípadì chce u¾ivatel buï ukonèit program, stisknul klávesu Escape, nebo se nezdaøilo pøepnutí mezi oknem a fullscreenem.</p>

<p>Uvnitø funkce deklarujeme promìnnou typu SDL_Event, kterou budeme v cyklu naplòovat událostmi èekajícími ve frontì. Pokud je fronta prázdná, cyklus, a tedy i celá funkce se ukonèí a øízení je pøedáno hlavní smyèce programu.</p>

<pre>
bool ProcessEvent()
{
	SDL_Event event;// Objekt události

	while(SDL_PollEvent(&amp;event))
	{
</pre>

<p>Rozvìtvíme kód podle typu události a pokud se jedná o klávesnici, zanoøíme se, v závislosti na typu klávesy, je¹tì více do hloubky. O¹etøen je pouze Escape ukonèující aplikaci a F1, která zpùsobí pøepnutí do/z fullscreenu.</p>

<p>Mimochodem, názvy kláves lze najít v SDL dokumentaci témìø dole pod nadpisem &quot;SDL Keysym definitions&quot; nebo v hlavièkovém souboru SDL_keysym.h.</p>

<pre>
		switch(event.type)
		{
		// Klávesnice
		case SDL_KEYDOWN:
			switch(event.key.keysym.sym)
			{
			case SDLK_ESCAPE:
				return false;
				break;

			case SDLK_F1:
				if(!ToggleFullscreen())
					return false;
				break;

			default:
				break;
			}
			break;
</pre>

<p>V ka¾dé aplikaci by mìl být o¹etøen SDL_QUIT, tato událost nastane, kdy¾ má být program ukonèen. U¾ivatel napøíklad klikl na køí¾ek v pravém horním rohu okna, stiskl ALT+F4, klikl pravým tlaèítkem my¹i v hlavním panelu na aplikaci a zvolil Zavøít atd. Zareagujeme, jak se oèekává, skonèíme.</p>

<pre>
		// Po¾adavek na ukonèení
		case SDL_QUIT:
			return false;
			break;
</pre>

<p>Pro zachování jednoduchosti tento ukázkový kód ostatní události ignoruje.</p>

<pre>
		// Ostatní se ignorují
		default:
			break;
		}
	}

	return true;
}
</pre>


<h2>Ukázkové programy</h2>

<h3>Úvod do událostí</h3>

<p>Program tentokrát nic nevykresluje, na zaèátku je nastavena ikona a titulek okna a poté se hlídají události klávesnice. Pokud je stisknut ESC, aplikace se ukonèí, v reakci na F1 se okno pøepne do celoobrazovkého re¾imu nebo zpìt, M okno minimalizuje a G zmìní zpùsob grabování vstupù (SDL_WM_GrabInput()). Pokud je stisknuta jiná klávesa, vypí¹e se její èíslo a jméno. <a href="./src/sdl_10_a.html">(zdrojový kód se zvýraznìním syntaxe)</a></p>

<div class="img"><img src="./data/10_prog_a.png" width="328" height="269" alt="Úvod do událostí" /></div>


<h2>Download</h2>

<p><ul>
<li><a href="./src/sdl_10_a.tar.gz">Pøíklad: Úvod do událostí</a></li>
<li><a href="sdl_10.tar.gz">Offline verze èlánku vèetnì v¹ech pøíloh</a></li>
</ul></p>


<h2>Pokraèování</h2>

<p>Pøí¹tì se budeme pøedev¹ím vìnovat operacím s frontou událostí, nauèíme se, jak z ní grabovat zprávy a naopak, jak je do ní vkládat.</p>


<div class="autor">Michal Turek - Woq &lt;WOQ (zavináè) seznam.cz&gt;, 28.03.2005</div>

</body>
</html>
